---
- name: Bootstrap base OS config
  hosts: all
  become: true
  gather_facts: true

  vars:
    bootstrap_users:
      - name: j.smith
        groups: ["wheel"]       
        shell: /bin/bash
        sudo_nopasswd: true
        authorized_keys: []

      - name: d.winchester
        groups: ["wheel"]
        shell: /bin/bash
        sudo_nopasswd: false
        authorized_keys: []

    ssh_disable_password_auth: true
    ssh_disable_root_login: true

  pre_tasks:
    - name: Show target OS
      debug:
        msg: "OS={{ ansible_distribution }} {{ ansible_distribution_version }} | Family={{ ansible_os_family }}"

  tasks:

    - name: Set hostname = inventory name
      ansible.builtin.hostname:
        name: "{{ inventory_hostname }}"
      when: inventory_hostname is defined

    - name: Ensure /etc/hosts has localhost mapping for hostname (portable)
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1\s+'
        line: "127.0.0.1 localhost {{ inventory_hostname }}"
        create: true


    - name: Ensure /etc/hosts has 127.0.1.1 mapping (Debian-style, harmless elsewhere)
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.1\.1\s+'
        line: "127.0.1.1 {{ inventory_hostname }}"
        create: true

    - name: Render /etc/hosts block with all inventory hosts
      ansible.builtin.blockinfile:
        path: /etc/hosts
        create: true
        marker: "# {mark} ANSIBLE INVENTORY HOSTS"
        block: |
          {% for h in (groups['all'] | sort) %}
          {{ (hostvars[h].ansible_host
              | default(hostvars[h].ansible_default_ipv4.address)
              | default(h)) }} {{ h }}
          {% endfor %}

    - name: Update packages (RHEL/Amazon Linux via dnf/yum)
      ansible.builtin.package:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"

    - name: Update packages (Debian/Ubuntu via apt)
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist
      when: ansible_os_family == "Debian"

    - name: Install baseline packages
      ansible.builtin.package:
        name:
          - vim
          - git
          #- curl
          - wget
          - htop
          - chrony
        state: present

    - name: Ensure groups exist (from bootstrap_users)
      ansible.builtin.group:
        name: "{{ item }}"
        state: present
      loop: "{{ bootstrap_users | map(attribute='groups') | list | flatten | unique | reject('equalto', '') | list }}"

    - name: Create users
      ansible.builtin.user:
        name: "{{ item.name }}"
        shell: "{{ item.shell | default('/bin/bash') }}"
        groups: "{{ (item.groups | default([])) | join(',') }}"
        append: true
        create_home: true
        state: present
      loop: "{{ bootstrap_users }}"

    - name: Debug created users (post-check)
      ansible.builtin.command: "getent passwd {{ item.name }}"
      register: created_users_getent
      changed_when: false
      failed_when: false
      loop: "{{ bootstrap_users }}"

    - name: Show getent results
      ansible.builtin.debug:
        var: created_users_getent.results

    - name: Add authorized_keys for users
      ansible.builtin.authorized_key:
        user: "{{ item.0.name }}"
        key: "{{ item.1 }}"
        state: present
      loop: "{{ bootstrap_users | subelements('authorized_keys', skip_missing=True) }}"
      when: item.1 is defined and item.1 | length > 0

    - name: Ensure sudo package present (Debian name differs)
      ansible.builtin.package:
        name: "{{ 'sudo' }}"
        state: present

    - name: Configure sudoers for users (NOPASSWD if enabled)
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ item.name }}"
        content: |
          {{ item.name }} ALL=(ALL) {{ 'NOPASSWD: ' if (item.sudo_nopasswd | default(false)) else '' }}ALL
        owner: root
        group: root
        mode: "0440"
        validate: "/usr/sbin/visudo -cf %s"
      loop: "{{ bootstrap_users }}"
      when: item.groups is defined and ('wheel' in item.groups or 'sudo' in item.groups)

    - name: Disable PasswordAuthentication in sshd_config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^(#\s*)?PasswordAuthentication\s+'
        line: "PasswordAuthentication no"
        validate: "sshd -t -f %s"
      when: ssh_disable_password_auth | bool
      notify: restart ssh

    - name: Disable root login in sshd_config
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^(#\s*)?PermitRootLogin\s+'
        line: "PermitRootLogin no"
        validate: "sshd -t -f %s"
      when: ssh_disable_root_login | bool
      notify: restart ssh

    - name: Ensure SSH service enabled and running
      ansible.builtin.service:
        name: "{{ 'sshd' if ansible_os_family == 'RedHat' else 'ssh' }}"
        state: started
        enabled: true

    - name: Enable and start chrony
      ansible.builtin.service:
        name: "{{ 'chronyd' if ansible_os_family == 'RedHat' else 'chrony' }}"
        state: started
        enabled: true

  handlers:
    - name: restart ssh
      ansible.builtin.service:
        name: "{{ 'sshd' if ansible_os_family == 'RedHat' else 'ssh' }}"
        state: restarted